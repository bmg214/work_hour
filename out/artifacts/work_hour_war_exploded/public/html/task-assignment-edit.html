<!--添加、编辑部门-->
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <link rel="Bookmark" href="/favicon.ico">
    <link rel="Shortcut Icon" href="/favicon.ico"/>
    <!--[if lt IE 9]>
    <script type="text/javascript" src="../lib/html5shiv.js"></script>
    <script type="text/javascript" src="../lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="../static/h-ui/css/H-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/H-ui.admin.css"/>
    <link rel="stylesheet" type="text/css" href="../lib/Hui-iconfont/1.0.8/iconfont.css"/>
    <link rel="stylesheet" type="text/css" href="../static/h-ui.admin/skin/default/skin.css" id="skin"/>
    <!--[if IE 6]>
    <script type="text/javascript" src="../lib/DD_belatedPNG_0.0.8a-min.js"></script>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <!--/meta 作为公共模版分离出去-->
    <style>
        .one{
            width: 44%;
            height: 190px;
            border: 1px solid #D9D9D9;
            float: left;
            overflow-y: scroll;

        }
        .three{
            width: 10%;
            height: 190px;
            border: 1px solid #D9D9D9;
            float: left;
        }
        .three button{
            margin-left: 20%;
            margin-top:80%;
        }
        .two{
            width: 44%;
            height: 190px;
            border: 1px solid #D9D9D9;
            float: left;
            overflow-y: scroll;
        }
        .b{
            background-color: #D9D9D9;
        }
    </style>
</head>
<body>
<article class="page-container">
    <form action="" method="post" class="form form-horizontal" id="form-admin-task-add">
         <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>任务编号：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="number" name="number">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>任务名称：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="name" name="name">
            </div>
        </div>

        <div class="row cl">
             <label class="form-label col-sm-2"><span class="c-red">*</span>任务来源：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="source" name="source">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>项目：</label>
            <div class="formControls col-sm-4">
                <select type="text" id="project" class="input-text" placeholder="" ></select>
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>设备名称：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="equipmentNumber" name="equipmentNumber">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>工艺阶段：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="operationStage" name="operationStage">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>任务描述：</label>
            <div class="formControls col-sm-10">
                <input type="text" class="input-text" value="" placeholder="" id="taskDescribe" name="taskDescribe">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>开始日期：</label>
            <div class="formControls col-sm-4">
                <input type="date" class="input-text" value="" placeholder="" id="startDate" name="startDate">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>开始时间：</label>
            <div class="formControls col-sm-4">
                <input type="time" class="input-text" value="" placeholder="" id="startTime" name="startTime">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>结束日期：</label>
            <div class="formControls col-sm-4">
                <input type="date" class="input-text" value="" placeholder="" id="finishDate" name="finishDate">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>结束时间：</label>
            <div class="formControls col-sm-4">
                <input type="time" class="input-text" value="" placeholder="" id="finishTime" name="finishTime">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>预计工时（小时）：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="spendTime" name="spendTime">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>分配员工：</label>
            <div class="formControls col-sm-4">
                <button id="employeeName" class="btn btn-warning" name="employeeName">分配员工</button>
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>分派进度：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="dispatchRate" name="dispatchRate">
            </div>
            <label class="form-label col-sm-2"><span class="c-red">*</span>完成进度：</label>
            <div class="formControls col-sm-4">
                <input type="text" class="input-text" value="" placeholder="" id="completeRate" name="completeRate">
            </div>
        </div>

        <div class="row cl">
            <label class="form-label col-sm-2"><span class="c-red">*</span>分配备注：</label>
            <div class="formControls col-sm-10">
                <input type="text" class="input-text" value="" placeholder="" id="remark" name="remark">
            </div>
        </div>

        <div class="row cl">
            <div class="col-sm-7 col-sm-offset-5">
                <button type="submit" class="btn btn-success radius" id="admin-project-save" name="admin-project-save">
                    <i class="icon-ok"></i> 保存
                </button>
            </div>
        </div>
    </form>
</article>


<!--模态框-->
<div class="modal fade" id="myModal" style="height: 400px;width: 800px">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <span>分配员工</span><br>
                <div class="one" ></div>
                <div class="three">
                    <button id="btnRight">增加</button>
                    <button id="btnLeft">移除</button>
                </div>
                <div class="two"></div>
                <div style="clear: both"></div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">关闭</button>
                <button type="button" class="btn btn-primary">提交</button>
            </div>
        </div>
    </div>
</div>

<input type="text" id="d_id" style="display: none;">

<script type="text/javascript" src="../lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="../static/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="../static/h-ui.admin/js/H-ui.admin.js"></script>
<script type="text/javascript" src="../js/base.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.js"></script>

<script type="text/javascript">

    $(function () {
        //获取页面传过来的id
        var getInfo=window.location.search.slice(window.location.search.indexOf("=")+1);
        //根据上个页面传来的Id得到相应Id数据库的数据对应到input表单
        if(getInfo.length>0){
            $("#d_id").val(getInfo);
            var getdata = {
                id:getInfo
            };
            $.ajax({
                type: "post",
                url: "/taskQuery",
                data: getdata,
                success: function (data) {
                    $("#number").val(data[0].number),
                    $("#name").val(data[0].name),
                    $("#source").val(data[0].source),
                    $("#project").val(data[0].project),
                    $("#equipmentNumber").val(data[0].equipmentNumber),
                    $("#operationStage").val(data[0].operationStage),
                    $("#taskDescribe").val(data[0].taskDescribe),
                    $("#startDate").val(data[0].startDate),
                    $("#startTime").val(data[0].startTime),
                    $("#finishDate").val(data[0].finishDate),
                    $("#finishTime").val(data[0].finishTime),
                    $("#spendTime").val(data[0].spendTime),
                    //$("#employeeName").val(data[0].employeeName),
                    $("#dispatchRate").val(data[0].dispatchRate),
                    $("#completeRate").val(data[0].completeRate),
                    $("#remark").val(data[0].remark)
                },
                error: function (msg) {
                    console.log(msg);
                }
            })
        }
        //保存部门
        //必须输入的字段，不能为空
        $("#form-admin-task-add").validate({
            rules: {
                number: {
                    required: true
                },
                name: {
                    required: true
                },
                source: {
                    required: true
                },
                projectNumber: {
                    required: true
                },
                projectName: {
                    required: true
                },
                equipmentNumber: {
                    required: true
                },
                operationStage: {
                    required: true
                },
                taskDescribe: {
                    required: true
                },
                startDate: {
                    required: true
                },
                startTime: {
                    required: true
                },
                finishDate: {
                    required: true
                },
                finishTime: {
                    required: true
                },
                spendTime: {
                    required: true
                },
                employeeName: {
                    required: true
                },
                dispatchRate: {
                    required: true
                },
                completeRate: {
                    required: true
                },
                remark: {
                    required: true
                }
            },
            onkeyup: false,
            focusCleanup: true,
            success: "valid",
            submitHandler: function (form) {
                var postData = {
                    number: $("#number").val(),
                    name: $("#name").val(),
                    source: $("#source").val(),
                    //获得下拉框中Option里面的value、number、name值并上传
                    projectId: $("#project option:selected")[0].getAttribute("value"),
                    projectNumber: $("#project option:selected")[0].getAttribute("number"),
                    projectName: $("#project option:selected")[0].getAttribute("name"),
                    equipmentNumber: $("#equipmentNumber").val(),
                    operationStage: $("#operationStage").val(),
                    taskDescribe: $("#taskDescribe").val(),
                    startDate: $("#startDate").val(),
                    startTime: $("#startTime").val(),
                    finishDate: $("#finishDate").val(),
                    finishTime: $("#finishTime").val(),
                    spendTime: $("#spendTime").val(),
                    //employeeId: $("#employeeName option:selected")[0].getAttribute("value"),
                    //employeeName: $("#employeeName").find("option:selected").text(),
                    dispatchRate: $("#dispatchRate").val(),
                    completeRate: $("#completeRate").val(),
                    remark: $("#remark").val(),
                    sysid: userInfo.id,
                    creater: userInfo.name
                };
                //修改部门
                if(getInfo.length>0){
                    postData.id = getInfo;
                    //用ajax提交
                    $.ajax({
                        type: "post",
                        url: "/taskEdit",
                        data: postData,
                        success: function (data) {
                            if(data == "1"){
                                layer.msg('任务修改成功', {
                                    icon:6,
                                    time:1000,
                                },function (res) {
                                    parent.location.reload();
                                    var index = parent.layer.getFrameIndex(window.name);
                                    parent.layer.close(index);
                                });
                         } else {
                                layer.msg('任务修改失败', {icon:6,time:1000});
                            }
                        }
                    });
                } else {
                    //新增部门
                    $.ajax({
                        type: "post",
                        url: "/taskAdd",
                        data: postData,
                        success: function (data) {
                            if(data == "1"){
                                layer.msg('任务新增成功', {
                                    icon:6,
                                    time:1000
                                },function () {
                                    parent.location.reload();
                                    var index = parent.layer.getFrameIndex(window.name);
                                    parent.layer.close(index);
                                });
                            } else {
                                layer.msg('新增失败,任务编号已存在', {icon:6,time:1000});
                            }
                        },
                        error: function (msg) {
                            console.log(msg);
                        }
                    });
                }
          }});

        //获取项目表的项目编号与名称，并显示到select下拉菜单中
        $.ajax({
            type: "post",
            url: "/projectList",
            success: function (data) {
                var num =eval(data);
                var select='';
                for(var i = 0;i<num.length;i++){
                    //option中添加value number name等属性
                    var option = '<option value="'+num[i].id+'" number="'+num[i].number+'" name="'+num[i].name+'">'+num[i].name+'/'+''+num[i].number+'</option>';
                    select += option;
                }
                //select的ID
                $("#project").append(select);
            },
        });

        //获取员工表的名字，并显示到select下拉菜单中
        $.ajax({
            type: "post",
            url: "/employeesList",
            success: function (data) {
                var num =eval(data);
                var selectEmployee='';
                for(var i = 0;i<num.length;i++){
                    //option中添加value number name等属性
                    var optionemployee = '<option value="'+num[i].id+'">'+num[i].name+'</option>';
                    selectEmployee += optionemployee;
                }
                //select的ID
                $(".one").append(selectEmployee);
            },
        });
        //启动模态框
        $("#employeeName").click(function () {
            $("#myModal").modal({backdrop:false,keyboard:false});
        })

        //左右信息交换
            //记录上一次选中的对象
            var select;
            //记录这次值
            var info ;
            $("p").click(function () {
                if(select!=undefined){
                    //移除上一次选中对象的样式
                    select.removeClass("b");
                    //记录下这次选中的对象
                    select = $(this);
                    //给这次对象添加样式
                    select.addClass("b")
                }else{//首次选中添加样式
                    //添加样式
                    $(this).addClass("b");
                    //记录这次选中的对象
                    select =$(this);
                }
            })
            //右移
            $("#btnRight").click(function () {
                info = select.detach();
                $(".two").append(info);
            })
            //左移
            $("#btnLeft").click(function () {
                info = select.detach();
                $(".one").append(info);
            })


    })



</script>

</body>
</html>